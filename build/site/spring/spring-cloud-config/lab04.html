                <!DOCTYPE html>
<html lang="en">
<head>

<meta name="course version" content="1.1.0">
<meta name="generator" content="io.pivotal.pal.shipkin:shipkin-plugin:5.1.0, https://github.com/platform-acceleration-lab/shipkin">
<meta name="generated on" content="2018-04-10T21:46:01.129Z">
<meta name="theme-color" content="#00ae9e">


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Pivotal Azure Workshop</title>

<link rel="icon" href="../../images/favicon.ico">

<link rel="stylesheet" href="../../css/reset.css">
<link rel="stylesheet" href="../../css/theme.css">
<link rel="stylesheet" href="../../css/highlight.js.min.css">
<link rel="stylesheet" href="../../css/github.css">

<style>

    #header {
        border-color: #86c775;
        background-color: #00ae9e;
    }

    footer {
        background-color: #00ae9e;
    }

    .label.label-primary {
        background-color: #009fdf;
    }

    a {
        color: #009fdf;
    }

    .label.label-primary:hover, .label.label-primary:focus {
        background-color: #faeee;
    }

    a:hover, a:focus {
        color: #faeee;
    }

    .slide {
        color: #00ae9e;
    }

    .slide h2, .slide label {
        color: #009fdf;
    }

    .slide input {
        color: rgba(0, 174, 158, 0.65);
    }

    .face path {
        fill: #009fdf;
    }

    body {
        background-color: #fffff0;
    }

    .slide {
        background-color: rgba(255, 255, 240, 0.9);
    }

    .slide.text {
        background-color: #fffff0;
    }

    .slide h2, .slide label {
        color: inherit;
    }



    .slide:before {
        background-image: url(../../images/sheep.png);
        background-size: contain;
        background-repeat: no-repeat;
        content: "";

        height: 120px;
        width: 115px;
        position: fixed;
        top: 20px;
        left: 20px;
    }
</style>

</head>
<body>


<style>
    #header {
        background: linear-gradient(rgba(0, 174, 158, 0.65), rgba(0, 174, 158, 0.65)), url(../../images/cloud-security.jpg) no-repeat center;
        background-size: cover;

    }
</style>

<header id="header">
    <div class="container">
        <img src="../../images/scs-logo.png" alt="Pivotal Azure Workshop logo">

        <div>
            <a href="../..">
                <h1>Pivotal Azure Workshop</h1>

            </a>

        </div>
    </div>
</header>


<a class="feedback" href="https://docs.google.com/forms/d/e/1FAIpQLSdR2-woVmejvILly2I_BYuXQyAY_xAo5ygvTnjJGHsjx7lfHw/viewform" data-url-field="entry.1985209097" target="_blank" rel="noreferrer noopener">
    <button>feedback</button>
</a>

<main id="main">

    <div id="content" class="container">
        <article>
 <h1 id="overview">Overview</h1>
<p>In this lab we’ll utilize Spring Boot and Spring Cloud to configure our application from a configuration dynamically retrieved from a git repository. We’ll then deploy it to Pivotal Cloud Foundry and auto-provision an instance of a configuration server using Pivotal Spring Cloud Services.</p>
<h1 id="update-hello-rest-service">Update <em>Hello</em> REST service</h1>
<ol>
<li>
<p>These features are added by adding
<code>spring-cloud-services-starter-config-client</code> to the classpath.</p>
<p>Add the following to Maven <code>dependencies</code>:</p>
<p><strong>cloud-native-spring/pom.xml.</strong></p>
<pre><code class="language-xml">&lt;project&gt;
    [...]
    &lt;dependencies&gt;
    [...]
    &lt;dependency&gt;
        &lt;groupId&gt;io.pivotal.spring.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-services-starter-config-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    [...]
    &lt;/dependencies&gt;
    [...]
&lt;/project&gt;
</code></pre>
</li>
<li>
<p>We also need to add a general entry for Spring Cloud dependency management. Add this snippet to your Maven project:</p>
<p><strong>cloud-native-spring/pom.xml.</strong></p>
<pre><code>&lt;project&gt;
    [...]
    &lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
        &lt;groupId&gt;io.pivotal.spring.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-services-dependencies&lt;/artifactId&gt;
        &lt;version&gt;{spring-cloud-services-dependencies-version}&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
        &lt;version&gt;{spring-cloud-dependencies-version}&lt;/version&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
    [...]
&lt;/project&gt;
</code></pre>
</li>
<li>
<p>Add an <code>@Value</code> annotation, private field, and associated usage to the <code>CloudNativeSpringApplication</code> class.</p>
<p><strong>cloud-native-spring/src/main/java/io/pivotal/CloudNativeSpringApplication.java.</strong></p>
<pre><code class="language-java">@Value(&quot;${greeting:Hola}&quot;)
private String greeting;

@RequestMapping(&quot;/&quot;)
public String hello() {
    return greeting + &quot; World!&quot;;
}
</code></pre>
<p>Completed:</p>
<p><strong>cloud-native-spring/src/main/java/io/pivotal/CloudNativeSpringApplication.java.</strong></p>
<pre><code class="language-java">package io.pivotal.cloudnativespring;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Import;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.data.rest.webmvc.config.RepositoryRestMvcConfiguration;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
@EnableJpaRepositories
@Import(RepositoryRestMvcConfiguration.class)
public class CloudNativeSpringApplication {

    @Value(&quot;${greeting:Hola}&quot;)
    private String greeting;

    public static void main(String[] args) {
        SpringApplication.run(CloudNativeSpringApplication.class, args);
    }

    @RequestMapping(&quot;/&quot;)
    public String hello() {
        return greeting + &quot; World!&quot;;
    }
}
</code></pre>
</li>
<li>
<p>When we introduced the Spring Cloud Services Starter Config Client dependency Spring Security will also be included (Config servers will be protected by OAuth2). However, this will also enable basic authentication to all our service endpoints.</p>
<p>Add the following to your Spring Boot configuration:</p>
<p><strong>cloud-native-spring/src/main/resources/application.yml.</strong></p>
<pre><code class="language-yaml">security:
    basic:
    enabled: false
</code></pre>
</li>
<li>
<p>We’ll also want to give our Spring Boot application a name so that it can lookup application-specific configuration from the config server later.</p>
<p>Add the following to your Spring Boot configuration:</p>
<p><strong>cloud-native-spring/src/main/resources/application.yml.</strong></p>
<pre><code class="language-yaml">spring:
    application:
    name: cloud-native-spring
</code></pre>
</li>
<li>
<p>Complete YML:</p>
<pre><code class="language-yaml">spring:
    application:
    name: cloud-native-spring

info:
    build:
    artifact: &quot;@project.artifactId@&quot;
    name: &quot;@project.name@&quot;
    description: &quot;@project.description@&quot;
    version: &quot;@project.version@&quot;

endpoints:
    sensitive: false

management:
    security:
    enabled: false
    info:
    git:
        mode: full
    cloudfoundry:
    enabled: true
    skip-ssl-validation: false # set to true if using an insecure CF environment

security:
    basic:
    enabled: false
</code></pre>
</li>
<li>
<p>Run the <em>cloud-native-spring</em> Application and verify dynamic config is working:</p>
<pre><code class="language-sh">CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
</code></pre>
</li>
<li>
<p>Browse to <a href="http://localhost:8080" rel="noreferrer noopener">http://localhost:8080</a> and verify you now see your new default greeting:</p>
<p><strong>Hola World!</strong></p>
</li>
<li>
<p>Stop the <em>cloud-native-spring</em> application</p>
</li>
</ol>
<h1 id="create-spring-cloud-config-server-instance">Create Spring Cloud Config Server instance</h1>
<ol>
<li>
<p>Now that our application is ready to read its config from a cloud config server, we need to deploy one! This can be done through Cloud Foundry using the services marketplace. Browse to the marketplace in Pivotal Cloud Foundry Apps Manager, navigate to the space you have been using to push your app, and select Config Server:</p>
<p><img src="images/config-scs.jpg" alt="" /></p>
</li>
<li>
<p>In the resulting details page, select the <em>standard</em>, single tenant plan. Name the instance <code>config-server</code>, select the space that you’ve been using to push all your applications. At this time you don’t need to select a application to bind to the service:</p>
<p><img src="images/config-scs1.jpg" alt="" /></p>
</li>
<li>
<p>After we create the service instance you’ll be redirected to your <em>Space</em> landing page that lists your apps and services. The config server is deployed on-demand and will take a few moments to deploy. Once the message <em>Creating service instance…</em> disappears, click on the service you provisioned. Select the <strong>Manage</strong> link towards the top of the resulting screen. This view shows the instance id and a JSON document showing the current configuration. The <code>count</code> element shows how many instances of Config Server we have provisioned:</p>
<p><img src="images/config-scs2.jpg" alt="" /></p>
</li>
<li>
<p>We now need to update the service instance with our GIT repository information where our configuration files are stored. For this example, we are using the <code>config</code> branch of our workshop repository.</p>
<p>Using the Cloud Foundry CLI execute the following update service command:</p>
<pre><code class="language-sh">CN-Workshop/labs/my_work/cloud-native-spring $ cf update-service config-server -c '{&quot;git&quot;: { &quot;uri&quot;: &quot;https://github.com/Pivotal-Field-Engineering/CN-Workshop&quot;, &quot;label&quot;: &quot;config&quot; } }'
</code></pre>
</li>
<li>
<p>Refresh you Config Server management page and you will see the following message. Wait until the screen refreshes and the service is reintialized:</p>
<p><img src="images/config-scs3.jpg" alt="" /></p>
</li>
<li>
<p>We will now bind our application to our <code>config-server</code>. Add these entries to our Cloud Foundry manifest:</p>
<p><strong>cloud-native-spring/manifest.yml.</strong></p>
<pre><code class="language-yaml">services:
- config-server
</code></pre>
<p>Complete:</p>
<pre><code class="language-yaml">---
applications:
- name: cloud-native-spring
    random-route: true
    memory: 768M
    path: target/cloud-native-spring-0.0.1-SNAPSHOT-exec.jar
    timeout: 180
    env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
    services:
    - config-server
</code></pre>
</li>
</ol>
<h2 id="deploy-and-test-application">Deploy and test application</h2>
<ol>
<li>
<p>Build the application</p>
<pre><code class="language-sh">CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw package
</code></pre>
</li>
<li>
<p>Push application into Cloud Foundry</p>
<pre><code class="language-sh">CN-Workshop/labs/my_work/cloud-native-spring $ cf push
</code></pre>
</li>
<li>
<p>Test your application by navigating to the root URL of the application, which will invoke the hello() service. You should now see a greeting that is read from the cloud config server!</p>
<p><strong>Bonjour World!</strong></p>
</li>
<li>
<p>What just happened?? A Spring component within the Spring Cloud Starter Config Client module called a <em>service connector</em> automatically detected that there was a Cloud Config service bound into the application. The service connector configured the application automatically to connect to the cloud <code>config-server</code> and download the configuration and wire it into the application</p>
</li>
<li>
<p>If you navigate to the GIT repo we specified for our configuration, <a href="https://github.com/Pivotal-Field-Engineering/CN-Workshop/tree/config" rel="noreferrer noopener">https://github.com/Pivotal-Field-Engineering/CN-Workshop/tree/config</a>, you’ll see a file named <code>cloud-native-spring.yml</code>. This filename is the same as our <code>spring.application.name</code> value for our Spring Boot application. The configuration is read from this file, in our case the following property:</p>
<pre><code>greeting: Bonjour
</code></pre>
</li>
<li>
<p>Next we’ll learn how to register our service with a Service Registry and load balance requests using Spring Cloud components.</p>
</li>
</ol>
         </article>
        <div class="sidebar-container">
<nav id="sidebar">
    <div class="title">
        <a href="../../index.html">Return to Pivotal Azure Workshop</a>
    </div>
    <div class="content">
        <a href="#">Back to top</a>

<ul>
        <li>
        <a href="#overview">Overview</a>

        </li>
        <li>
        <a href="#update-hello-rest-service">Update Hello REST service</a>

        </li>
        <li>
        <a href="#create-spring-cloud-config-server-instance">Create Spring Cloud Config Server instance</a>

<ul>
        <li>
        <a href="#deploy-and-test-application">Deploy and test application</a>

        </li>
</ul>
        </li>
</ul>
    </div>
</nav>
        </div>
    </div>
</main>


<div class="slide" data-slide="1">
    <h1>Pivotal Azure Workshop</h1>
</div>

<div class="slide transparent" data-slide="2">
    <h1>Get started!</h1>
</div>

<div class="slide" data-slide="3">
    <h1>Wrap up</h1>

    <div class="faces">
        <svg class="face" viewBox="0 0 24 24">
            <path d="M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22A10,10 0 0,0 22,12C22,6.47 17.5,2 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M13,9.94L14.06,11L15.12,9.94L16.18,11L17.24,9.94L15.12,7.82L13,9.94M8.88,9.94L9.94,11L11,9.94L8.88,7.82L6.76,9.94L7.82,11L8.88,9.94M12,17.5C14.33,17.5 16.31,16.04 17.11,14H6.89C7.69,16.04 9.67,17.5 12,17.5Z"/>
        </svg>

        <svg class="face" viewBox="0 0 24 24">
            <path d="M8.5,11A1.5,1.5 0 0,1 7,9.5A1.5,1.5 0 0,1 8.5,8A1.5,1.5 0 0,1 10,9.5A1.5,1.5 0 0,1 8.5,11M15.5,11A1.5,1.5 0 0,1 14,9.5A1.5,1.5 0 0,1 15.5,8A1.5,1.5 0 0,1 17,9.5A1.5,1.5 0 0,1 15.5,11M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M9,14H15A1,1 0 0,1 16,15A1,1 0 0,1 15,16H9A1,1 0 0,1 8,15A1,1 0 0,1 9,14Z"/>
        </svg>

        <svg class="face" viewBox="0 0 24 24">
            <path d="M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22A10,10 0 0,0 22,12C22,6.47 17.5,2 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M16.18,7.76L15.12,8.82L14.06,7.76L13,8.82L14.06,9.88L13,10.94L14.06,12L15.12,10.94L16.18,12L17.24,10.94L16.18,9.88L17.24,8.82L16.18,7.76M7.82,12L8.88,10.94L9.94,12L11,10.94L9.94,9.88L11,8.82L9.94,7.76L8.88,8.82L7.82,7.76L6.76,8.82L7.82,9.88L6.76,10.94L7.82,12M12,14C9.67,14 7.69,15.46 6.89,17.5H17.11C16.31,15.46 14.33,14 12,14Z"/>
        </svg>
    </div>
</div>


<div class="slide lemon-squeezy" data-slide="7">
    <h1>Easy peasy</h1>
    <h1>lemon squeezy!</h1>
</div>

<div class="slide" data-slide="8">
    <h1>Lunch time!</h1>
    <label for="lunch-end">will return</label>
    <input type="text" name="lunch-end" data-time>
</div>

<div class="slide" data-slide="9">
    <h1>Break time!</h1>
    <label for="break-end">will return</label>
    <input type="text" name="break-end" data-time>
</div>

<audio src="../../audio/gong.mp3"
       id="gong"
       preload>
</audio>

<div class="slide" data-slide="¿">
    <h2>Keyboard shortcuts</h2>
    <table>
        <thead>
        <tr>
            <th>Key</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>1</td>
            <td>Show <em>introduction</em> slide</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Show <em>get started</em> slide</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Show <em>wrap up</em> slide</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Show <em>instructor notes</em></td>
        </tr>
        <tr>
            <td>7</td>
            <td>Easy peasy</td>
        </tr>
        <tr>
            <td>8</td>
            <td>Show <em>lunch time</em> slide</td>
        </tr>
        <tr>
            <td>9</td>
            <td>Show <em>break time</em> slide</td>
        </tr>
        <tr>
            <td>0</td>
            <td>Play gong sound</td>
        </tr>
        <tr>
            <td>ESC</td>
            <td>Close slide</td>
        </tr>
        <tr>
            <td>?</td>
            <td>Show this help message</td>
        </tr>
        </tbody>
    </table>
</div>

<footer>
    <a href="https://pivotal.io/legal" rel="noreferrer noopener">CONFIDENTIAL -
        © Copyright 2018 Pivotal Software, Inc. All Rights Reserved.</a>
    <div>
        <label class="hidden-checkbox">
            <input type="checkbox" id="instructor-mode">
            <span>course version: 1.1.0<sup class="check">IM</sup></span>
        </label>
    </div>
</footer>

<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="../../js/shipkin.js"></script>
<script src="../../js/slides.js"></script>

</body>
</html>

