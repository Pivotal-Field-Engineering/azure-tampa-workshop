# Overview

Spring Boot makes it easy to create stand-alone, production-grade Spring
based Applications that you can "just run". We take an opinionated view
of the Spring platform and third-party libraries so you can get started
with minimum fuss. Most Spring Boot applications need very little Spring
configuration.

# Spring

First we will use the Spring Boot starter tool to create a Java Spring project. Later we will add the various depedancies to connect
our project to Azure's Services.

## Create the Spring Starter App

1.  Browse to [Spring Initializr](https://start.spring.io)

2.  Generate a `Maven Project` with `Java 8` and Spring Boot `1.5.12`  

> ATTENTION: You will have to manually change the Spring Boot Version from 2.0.1 to 1.5.12. This project has not been configured for 2.0 yet.

3.  Fill out the **Project metadata** fields as follows:
    
    | Group  | Artifact  |
    |---|---|
    | `io.pivotal`  | `azure-storage-client`  |

1. In the dependencies section, add each of the following manually:
    
    - **Web**
    - **Azure Support**
    - **Azure Storage**

1. Click the *Generate Project* button and your browser will download the `azure-storage-client.zip` file.
1. In your favorite workspace directory create a directory called `CN-Workshop` and `/labs` inside it. This will be your working directory for these labs
1. Unzip the project to `CN-Workshop/labs/azure`.
1. From your IDE, import this project as an existing Maven project.
1. Now we need to create the application. Open this Java class in your project in your IDE. This is a skeleton application class auto-generated by Spring Initializr for you. `src/main/java/io/pivotal/azurestorageclient/AzureStorageClientApplication.java`
1. Add the @RestController annotation to the Class definition and the method _upload_ to this class from the code snippet below. After you add this code, your class should look exactly like this snippet below.


    ```java
	package io.pivotal.azurestorageclient;

	import org.springframework.beans.factory.annotation.Autowired;
	import org.springframework.boot.SpringApplication;
	import org.springframework.boot.autoconfigure.SpringBootApplication;
	import org.springframework.web.bind.annotation.RequestMapping;
	import org.springframework.web.bind.annotation.RequestParam;
	import org.springframework.web.bind.annotation.RestController;
	import org.springframework.web.multipart.MultipartFile;

	import com.microsoft.azure.storage.CloudStorageAccount;
	import com.microsoft.azure.storage.blob.BlobContainerPermissions;
	import com.microsoft.azure.storage.blob.BlobContainerPublicAccessType;
	import com.microsoft.azure.storage.blob.CloudBlobClient;
	import com.microsoft.azure.storage.blob.CloudBlobContainer;
	import com.microsoft.azure.storage.blob.CloudBlockBlob;

	@SpringBootApplication
	@RestController
	public class AzureStorageClientApplication {

		// for blob storage
		@Autowired
		private CloudStorageAccount cloudStorageAccount;

		@RequestMapping("/uploadfile")
		public String upload(@RequestParam("file") MultipartFile file,
				@RequestParam("azureContainerName") String azureContainerName) {

			String blobStoreUrl = "Failure";
			try {
				// Convert File to Byte Array
				final String fileName = file.getOriginalFilename();
				byte[] fileBytes = file.getBytes();

				// Upload File to Azure Storage Container
				CloudBlobClient client = cloudStorageAccount
						.createCloudBlobClient();
				CloudBlobContainer container = client
						.getContainerReference(azureContainerName);
				container.createIfNotExists();

				CloudBlockBlob blob = container.getBlockBlobReference(fileName);
				blob.upload(file.getInputStream(), fileBytes.length);

				// Get the URL to your uploaded file
				BlobContainerPermissions permissions = container
						.downloadPermissions();
				permissions
						.setPublicAccess(BlobContainerPublicAccessType.CONTAINER);
				container.uploadPermissions(permissions);
				blobStoreUrl = blob.getUri().toString();

			} catch (Exception e) {
				e.printStackTrace();
			}
			return blobStoreUrl;
		}

		public static void main(String[] args) {
			SpringApplication.run(AzureStorageClientApplication.class, args);
		}
	}
    ```

1. Compile the demo application with Maven:

    ```sh
    ./mvnw clean install -Dmaven.test.skip=true
    ```
# Azure Service Broker

Here we will prepare Azure with the storage service we need for our Spring Boot App. This is done via the Cloudfoundry CLI using the JSON configuraton file below.

## Prepare Azure Blob Storage.

1. Create a JSON file called `azure-storage.json`:
    ```json
    {
    "resource_group_name": "tampajava",
    "storage_account_name": "<MYSTORAGENAME>",
    "location": "westus",
    "account_type": "Standard_LRS"
    }
    ```
1. Modify the JSON and replace   \<MYSTORAGENAME\>    to be unique and use lowercase letters. This will be your storage_account_name. 
2. Create an Azure Storage service instance by running the following cf command:

    `cf create-service azure-storage standard MY-AZURE-STORAGE -c ./azure-storage.json`

3. Run 'cf services' (or login to the Cloud Foundry Apps Manager https://apps.sys.tampa.get.pivotal.io) to confirm the service is created successfully.

## Deploy to Cloud Foundry

1. In order to deploy the starter app to Cloud Foundry efficiently, we'll need to create a manifest. Edit `CN-Workshop/labs/azure/manifest.yml` and populate it with your Application-specific values. 

Give your application a unique name that includes your initials as a prefix or suffix to the app name: Example `pb-azure-spring-app`. Add the correct path to your Build (JAR) file which maven puts in the 'target/' subdirectory.

```yaml
---
  applications:
  - name: MY-APP-NAME
    memory: 1G
    instances: 1
    path: target/MY-APP-JAR.jar
```    

1. Now the application is ready to be pushed to Cloud Foundry.
    ```sh
    cf push --no-start
    ```

1. Now we have to bind the app to the Service Instance previously created.
    ```sh
    cf bind-service MY-APP-NAME MY-AZURE-STORAGE
    ```

1. Now we need to start our application.
    ```sh
    cf start MY-APP-NAME
    ```

## Test Our App
You'll need a tool like POSTMAN to test your app. https://www.getpostman.com/. Execute the below steps to test your app. 
* Launch POSTMAN. Enter the appropriate values for your test.
* Your App's endpoint should be `<YOUR_APP_URL>/uploadfile`. (Your app's URL can be captured from the output of `cf push` or from the Apps Manager)
* set the verb to `POST`
* Under `body`, define 2 parameters (Key-Value pairs)
 (1) Key=`file`, Type=`File`; Value = choose some lightweight file from your laptop you want to upload. Example - an image. 
 (2) Key=`azureContainerName`, Type=`Text`; Value = pass a name for your Azure Blob Container. This container will be created if it doesn't exist
* Click the `Send` button. The response should contain the Azure Blobstore URL for your uploaded file. 
* Capture the URL from the response from the above step and you should be able to download your file from this URL, which proves that your upload was successful.
